name: cve-monitor

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
jobs:
  cve-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    environment: CI
    # æ˜ç¡®è®¾ç½®GitHub Actionså†…ç½®tokençš„æƒé™
    permissions:
      contents: write  # å…è®¸è¯»å†™ä»“åº“å†…å®¹
      actions: read    # å…è®¸è¯»å–actionsä¿¡æ¯
    steps:
      - name: checkout the repo
        uses: actions/checkout@v2
      
      - name: ç”Ÿæˆå‰ç«¯é…ç½®æ–‡ä»¶
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†secrets.GH_TOKENï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKEN
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "æœªé…ç½®secrets.GH_TOKENï¼Œé…ç½®æ–‡ä»¶å°†ä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKENå ä½ç¬¦"
            GH_TOKEN_VALUE="${{ secrets.GITHUB_TOKEN }}"
            TOKEN_NOTE="GitHub Actionså†…ç½®Token"
          else
            echo "ä½¿ç”¨é…ç½®çš„secrets.GH_TOKEN"
            GH_TOKEN_VALUE="${{ secrets.GH_TOKEN }}"
            TOKEN_NOTE="ç”¨æˆ·é…ç½®çš„secrets.GH_TOKEN"
          fi
          
          # ä¸ºå‰ç«¯ç”Ÿæˆå®‰å…¨çš„é…ç½®æ–‡ä»¶
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p docs/data
          mkdir -p docs/config
          
          cat > docs/config/config.json << EOF
          {
            "github_token": "$GH_TOKEN_VALUE",
            "api_base_url": "https://api.github.com",
            "repository": "adminlove520/github_cve_monitor",
            "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "token_note": "$TOKEN_NOTE"
          }
          EOF
          
          cat > docs/data/config.json << EOF
          {
            "github_token": "$GH_TOKEN_VALUE",
            "api_base_url": "https://api.github.com",
            "repository": "adminlove520/github_cve_monitor",
            "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "token_note": "$TOKEN_NOTE"
          }
          EOF
          
          echo "âœ… å‰ç«¯é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
      - name: install dependencies
        run: |
          pip3 install -r requirements.txt
      - name: run scraper
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†secrets.GH_TOKENï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKEN
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "æœªé…ç½®secrets.GH_TOKENï¼Œä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKEN"
            export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            TOKEN_SOURCE="GitHub Actionså†…ç½®Token"
          else
            echo "ä½¿ç”¨é…ç½®çš„secrets.GH_TOKEN"
            export GITHUB_TOKEN="${{ secrets.GH_TOKEN }}"
            TOKEN_SOURCE="ç”¨æˆ·é…ç½®çš„secrets.GH_TOKEN"
          fi
          
          # ç¡®ä¿Tokenä¸ä¸ºç©º
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "è­¦å‘Š: æœªæ‰¾åˆ°æœ‰æ•ˆçš„GitHub Tokenï¼Œå°†ä½¿ç”¨æ— è®¤è¯è¯·æ±‚ï¼ˆAPIé€Ÿç‡é™åˆ¶ä¸¥é‡ï¼‰"
            echo "Tokenæ¥æº: æ— æœ‰æ•ˆToken"
          else
            echo "GitHub Tokenå·²è®¾ç½®"
            echo "Tokenæ¥æº: $TOKEN_SOURCE"
            echo "Tokené•¿åº¦: ${#GITHUB_TOKEN}"
          fi
          
          python3 main.py
          
      - name: ç”ŸæˆWikiç»Ÿè®¡æ•°æ®
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          python3 scripts/generate_wiki_stats.py
      - name: save changes
        run: |
          git config --global user.email "cve-monitor@users.noreply.github.com"
          git config --global user.name "CVE-Bot"
          DATE_STR=$(date +"%Y-%m-%d")
          git add .
          git commit --all --message "æ¯æ—¥æƒ…æŠ¥é€Ÿé€’æ›´æ–°ï¼šdaily_${DATE_STR}.md" || echo "no changes to commit"
          git push
      - name: Update Wiki
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†secrets.GH_TOKENï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKEN
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "æœªé…ç½®secrets.GH_TOKENï¼Œä½¿ç”¨GitHub Actionså†…ç½®çš„GITHUB_TOKEN"
            WIKI_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          else
            echo "ä½¿ç”¨é…ç½®çš„secrets.GH_TOKEN"
            WIKI_TOKEN="${{ secrets.GH_TOKEN }}"
          fi
          
          # ç¡®ä¿Tokenä¸ä¸ºç©º
          if [ -z "$WIKI_TOKEN" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°æœ‰æ•ˆçš„GitHub Tokenï¼Œæ— æ³•æ›´æ–°Wiki"
            exit 1
          fi
          
          # å…‹éš† Wiki ä»“åº“
          git clone https://x-access-token:$WIKI_TOKEN@github.com/adminlove520/github_cve_monitor.wiki.git wiki
          cd wiki
          
          # æ›´æ–°ä¸»é¡µ
          cp ../wiki_content/Home.md ./Home.md
          
          # æ›´æ–°æ¯æ—¥æŠ¥å‘Šé¡µé¢
          DATE_STR=$(date +"%Y-%m-%d")
          WEEK_STR=$(date +"%Y-W%V-%m-%d")
          
          # åŠ¨æ€ç”Ÿæˆæ¯æ—¥æŠ¥å‘Šé¡µé¢
          cat > "æ¯æ—¥æŠ¥å‘Š.md" << EOF
          # æ¯æ—¥æƒ…æŠ¥é€Ÿé€’
          
          > CVE ç›‘æ§ç³»ç»Ÿæ¯æ—¥è‡ªåŠ¨ç”Ÿæˆçš„å®‰å…¨æƒ…æŠ¥æŠ¥å‘Š
          
          ## æœ€æ–°æŠ¥å‘Š
          
          ### 2025å¹´9æœˆ
          
          #### Week 38
          
          - ğŸ“… [${DATE_STR} æ¯æ—¥æŠ¥å‘Š](https://adminlove520.github.io/github_cve_monitor/data/${WEEK_STR}/daily_${DATE_STR//-/}.md) - æœ€æ–°
          EOF
          
          # æ·»åŠ å†å²æŠ¥å‘Šé“¾æ¥
          if [ -d "../docs/data" ]; then
            echo "" >> "æ¯æ—¥æŠ¥å‘Š.md"
            for dir in ../docs/data/*/; do
              if [ -d "$dir" ]; then
                dir_name=$(basename "$dir")
                if [ "$dir_name" != "${WEEK_STR}" ]; then
                  for file in "$dir"daily_*.md; do
                    if [ -f "$file" ]; then
                      file_name=$(basename "$file" .md)
                      date_part=$(echo "$file_name" | sed 's/daily_//' | sed 's/\(.\{4\}\)\(.\{2\}\)\(.\{2\}\)/\1-\2-\3/')
                      echo "- ğŸ“… [$date_part æ¯æ—¥æŠ¥å‘Š](https://adminlove520.github.io/github_cve_monitor/data/$dir_name/$file_name.md)" >> "æ¯æ—¥æŠ¥å‘Š.md"
                    fi
                  done
                fi
              fi
            done
          fi
          
          # æ·»åŠ æŠ¥å‘Šè¯´æ˜
          cat >> "æ¯æ—¥æŠ¥å‘Š.md" << 'EOF'
          
          ## æŠ¥å‘Šå†…å®¹è¯´æ˜
          
          æ¯æ—¥æŠ¥å‘ŠåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
          
          ### ğŸ“ˆ åŸºæœ¬ç»Ÿè®¡
          - ç”Ÿæˆæ—¶é—´
          - æ•°æ®æ¥æº
          - æ€»è®°å½•æ•°
          - æ–°å¢CVEæ•°é‡
          
          ### ğŸ” CVEè¯¦æƒ…
          æ¯ä¸ªCVEæ¡ç›®åŒ…å«ï¼š
          - **CVEç¼–å·**: å®˜æ–¹CVEæ ‡è¯†ç¬¦
          - **ç›¸å…³ä»“åº“**: GitHubä¸Šçš„POC/EXPä»“åº“é“¾æ¥
          - **æè¿°**: æ¼æ´è¯¦ç»†æè¿°
          - **æ—¥æœŸ**: å‘ç°/æ›´æ–°æ—¥æœŸ
          
          ### ğŸ“ˆ æ•°æ®æ ¼å¼
          ```
          | CVE | ç›¸å…³ä»“åº“ï¼ˆpoc/expï¼‰ | æè¿° | æ—¥æœŸ |
          |:---|:---|:---|:---|
          | [CVE-YYYY-NNNNN](é“¾æ¥) | [ä»“åº“å](ä»“åº“é“¾æ¥) | æ¼æ´æè¿° | æ—¥æœŸæ—¶é—´ |
          ```
          
          ## ä½¿ç”¨è¯´æ˜
          
          1. **æŸ¥çœ‹æœ€æ–°æŠ¥å‘Š**: ç‚¹å‡»ä¸Šæ–¹æœ€æ–°æ—¥æœŸçš„æŠ¥å‘Šé“¾æ¥
          2. **æœç´¢ç‰¹å®šCVE**: ä½¿ç”¨æµè§ˆå™¨çš„æœç´¢åŠŸèƒ½ (Ctrl+F) æŸ¥æ‰¾ç‰¹å®šCVEç¼–å·
          3. **å¯¼å‡ºæ•°æ®**: æŠ¥å‘Šæ”¯æŒå¤åˆ¶ç²˜è´´åˆ°å…¶ä»–æ–‡æ¡£
          4. **è®¢é˜…æ›´æ–°**: Watch ä»“åº“ä»¥æ¥æ”¶æ›´æ–°é€šçŸ¥
          
          ## è‡ªåŠ¨åŒ–æµç¨‹
          
          ```mermaid
          graph TD
              A[æ¯æ—¥å‡Œæ™¨1:00 UTC] --> B[GitHub Actions è§¦å‘]
              B --> C[è¿è¡Œ Python è„šæœ¬]
              C --> D[æ”¶é›†GitHub CVEæ•°æ®]
              D --> E[ç”ŸæˆMarkdownæŠ¥å‘Š]
              E --> F[æäº¤åˆ°ä»“åº“]
              F --> G[æ›´æ–°GitHub Pages]
              G --> H[åŒæ­¥åˆ°Wiki]
          ```
          
          ## æ•°æ®æ¥æº
          
          - **GitHub CVEæ•°æ®åº“**: https://github.com/advisories
          - **APIé™åˆ¶**: æ¯å°æ—¶5000æ¬¡è¯·æ±‚ï¼ˆä½¿ç”¨Tokenè®¤è¯ï¼‰
          - **æ•°æ®èŒƒå›´**: åŒ…å«POC/EXPçš„CVEè®°å½•
          
          ---
          
          ğŸ’¡ **æç¤º**: å»ºè®®å®šæœŸæŸ¥çœ‹æ¯æ—¥æŠ¥å‘Šï¼ŒåŠæ—¶äº†è§£æœ€æ–°çš„å®‰å…¨æ¼æ´ä¿¡æ¯ã€‚
          EOF
          
          # æ›´æ–°å…¶ä»–é¡µé¢
          cp ../wiki_content/å…³äºé¡¹ç›®.md "./å…³äºé¡¹ç›®.md"
          cp ../wiki_content/æ›´æ–°æ—¥å¿—.md "./æ›´æ–°æ—¥å¿—.md"
          # å¤åˆ¶ç»Ÿè®¡æ•°æ®é¡µé¢ï¼ˆå·²ç”±generate_wiki_stats.pyè‡ªåŠ¨ç”Ÿæˆï¼‰
          cp ../wiki_content/ç»Ÿè®¡æ•°æ®.md "./ç»Ÿè®¡æ•°æ®.md"
          
          # æäº¤æ›´æ–°
          git config user.name "CVE-Bot"
          git config user.email "cve-monitor@users.noreply.github.com"
          git add .
          git commit -m "æ›´æ–°Wikiæ–‡æ¡£ - ${DATE_STR}" || echo "Wiki no changes to commit"
          git push